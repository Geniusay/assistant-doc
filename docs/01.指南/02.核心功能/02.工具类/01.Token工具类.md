---
title: Tokenå·¥å…·ç±»
date: 2023-04-04 14:17:46
permalink: /pages/293a4c/
article: false
---

[ğŸ‘‰ æºç ](https://github.com/969025903/Assistant)
```xml
<dependency>
    <groupId>io.github.969025903</groupId>
    <artifactId>assistant</artifactId>
    <version>æœ€æ–°ç‰ˆæœ¬</version>
</dependency>
```

# TokenUtil

::: tip ç®€è¿°
ä¸€æ¬¾tokenè‡ªåŠ¨ç”Ÿæˆï¼Œè§£æå·¥å…·ï¼Œç›®å‰åŒ…å«Tokençš„åŸºæœ¬åŠŸèƒ½ä»¥åŠrefresh-tokenåŠŸèƒ½
å…³äºä»€ä¹ˆæ˜¯[Token](https://www.jianshu.com/p/576dbf44b2ae/)
:::

## é…ç½®
TokenUtil å†…éƒ¨çš„é…ç½®ç”±JWTTokenPropertieså†³å®š
| å±æ€§å | ç±»å‹ | é»˜è®¤å€¼ | æè¿° |
| :-: | :-: | :-: | :-: |
| accessTokenName | String | accessToken | tokenåå­— |
| accessTokenExpireTime | String | 30 | è®¿é—®tokenè¿‡æœŸæ—¶é—´ |
| accessTokenTimeUnit | String | MINUTES | tokenè¿‡æœŸæ—¶é—´å•ä½(è¯·å…¨éƒ¨å¤§å†™ï¼Œé‡‡ç”¨TimeUnitçš„æ—¶é—´å•ä½æ ¼å¼) |
| enableRefresh | Boolean | false | æ˜¯å¦å¼€å¯åˆ·æ–°token |
| refreshTokenName | String | refreshToken | tokenåå­— |
| refreshTokenExpireTime | String | 24 | åˆ·æ–°tokenè¿‡æœŸæ—¶é—´ |
| refreshTokenTimeUnit | String | HOURS | refresh-tokenè¿‡æœŸæ—¶é—´å•ä½(è¯·å…¨éƒ¨å¤§å†™ï¼Œé‡‡ç”¨TimeUnitçš„æ—¶é—´å•ä½æ ¼å¼) |
| tokenSecret | String | cuAihCz53DZRjZwbsGcZJ2Ai6At+T142uphtJMsk7iQ= | tokenå¯†é’¥ |
| isRandomJIT | Boolean | false | æ˜¯å¦éšæœºç”Ÿæˆjti |
ä»¥ä¸Šè¿™äº›é…ç½®å‡å¯å†ymlæ–‡ä»¶ä¸­é…ç½®ï¼Œæ ¼å¼å¦‚ä¸‹â¬‡
```yaml
assistant:
  token:
    access-token-expire-time: 3600
    access-token-time-unit: SECONDS
    enable-refresh: true
```

## ä½¿ç”¨

### åˆå§‹åŒ–

```java
@Autowired
TokenUtil tokenUtils;

class User{
    private String name;
    private int age;
    public User(String name, int age) {
        this.name = name;
        this.age = age;
    }
User user = new User("Genius",18);
}
```
### åˆ›å»ºToken
åˆ›å»ºTokenæœ‰è®¸å¤šæ–¹å¼ï¼Œè¿™é‡Œä¸€ä¸€æ¥ä»‹ç»ä¸€ä¸‹,åœ¨ä½¿ç”¨TokenUtilsæ—¶ï¼Œä¼šæ ¹æ®ä½ çš„å‚æ•°è¿”å›ä¸€ä¸ªTokenç±»ï¼ŒTokenç±»ä¸­åŒ…å«äº†Access-Tokenç­‰ç­‰ä¿¡æ¯ï¼Œæ¥ä¸‹æ¥
æˆ‘ä»¬å¸®ä¸Šè¿°çš„Userå¯¹å†™å°è£…åˆ°Tokenä¸­

1ï¼Œå•ä¸ªpayload Tokenåˆ›å»º 
```java
//Token<T> createToken(String payloadName,T payload,String subject) payloadåç§°ï¼Œpayloadï¼Œå…¬å…±éƒ¨åˆ†
String token = tokenUtils.createToken("user",user,"123456").getAccessToken();
```

2ï¼Œå¤šä¸ªpayload Tokenåˆ›å»º
```java
//Token<T> createToken(Map<String,Object> payload,String subject)
String token2 = tokenUtils.createToken(Map.of("user",user,"ID","123456"),"123456").getAccessToken();
```

3ï¼Œè¯¦ç»†Tokenåˆ›å»º
```java
/*
 * åˆ›å»ºtoken
 * @param header å¤´éƒ¨
 * @param claims ç§æœ‰éƒ¨åˆ†,ä¸å»ºè®®å­˜æ”¾ç§å¯†ä¿¡æ¯
 * @param iat jwtç­¾å‘æ—¶é—´
 * @param exp jwtè¿‡æœŸæ—¶é—´
 * @param nbf jwtç”Ÿæ•ˆæ—¶é—´
 * @param iss jwtç­¾åè€…
 * @param sub å…¬å…±éƒ¨åˆ†
 * @param jti jwtå”¯ä¸€èº«ä»½æ ‡è¯†ï¼Œjti
 * @param audience å‘å¸ƒäºº
 * @param isRefresh æ˜¯å¦åˆ·æ–°token
 */
Claims claims = Jwts.claims();
        claims.put("user",user);
String token3 = tokenUtils.createToken(
        Map.of("type","jwt","alg","HS256"), //tokenå¤´ä¿¡æ¯
        claims,                                             //token payload
        new Date(),                                         //tokenç­¾å‘æ—¶é—´
        new Date(new Date().getTime() + 60*1000),           //tokenè¿‡æœŸæ—¶é—´
        new Date(new Date().getTime() + 120*1000),          //tokenåˆ·æ–°æ—¶é—´,å¦‚æœæœªå¯ç”¨åˆ™æ— æ•ˆ
        new Date(new Date().getTime()),           //Tokenç”Ÿæ•ˆæ—¶é—´
        "Genius",                                           //tokenç­¾åè€…
        "public Path",                                      //å…¬å…±åŒºåŸŸ
        tokenUtils.getJwtTokenProperties().getJit(),        //tokenå”¯ä¸€èº«ä»½æ ‡è¯†
        "Genius",                                           //å‘å¸ƒäºº
        true                                               //æ˜¯å¦éœ€è¦è¿›è¡Œåˆ·æ–°æ“ä½œ
        ).getAccessToken();
```
### è§£æToken
::: warning æ³¨æ„
    è§£æTokenå‡½æ•°ç›®å‰ä¸å…·å¤‡è‡ªåŠ¨åˆ·æ–°access-tokençš„åŠŸèƒ½ï¼Œå¦‚æœä½ æƒ³å®ç°refreshåŠŸèƒ½ï¼Œè¯·æ­é…refreshTokenä½¿ç”¨
:::
è§£æTokenæœ‰å¤šç§æ–¹æ³•ä»¥åŠè¿”å›ç±»å‹
| æ–¹æ³•å | è¿”å›ç±»å‹ | å‚æ•° | æ–¹æ³•æè¿° |
| :-: | :-: | :-: | :-: |
| parseToken | Claims | String(tokenå­—ç¬¦ä¸²) | ç›´æ¥è¿”å›Claimsä¸»ä½“(ä¸æ¨èç›´æ¥ä½¿ç”¨) |
| parseTokenToObj | æ³›å‹T | String(tokenå­—ç¬¦ä¸²),String(éœ€è¦è·å–çš„payloadåç§°),Class(è½¬æ¢çš„ç±»å‹) | è§£æTokenè¿”å›payloadä¸­çš„å¯¹è±¡ |
| parseTokenToToken | Token  | String(tokenå­—ç¬¦ä¸²),String(éœ€è¦è·å–çš„payloadåç§°),Class(è½¬æ¢çš„ç±»å‹) | è§£æaccess-tokenå¹¶è¿”å›Tokenå¯¹è±¡ |
```java
Token<User> token1 = tokenUtils.parseTokenToToken(token, "user", User.class);
User user = tokenUtils.parseTokenToObj(token, "user", User.class);
```

### åˆ·æ–°Token
::: tip ç®€è¿°
    å…³äºrefresh-tokençš„ä½¿ç”¨ï¼Œaccess-tokenä½œä¸ºä¸€ä¸ªçŸ­æœŸtokenï¼Œrefresh-tokenä½œä¸ºä¸€ä¸ªé•¿æœŸtokenï¼Œå¦‚æœrefresh-tokenè¿˜æ²¡è¿‡æœŸï¼Œ
    ä½†æ˜¯access-token å·²ç»è¿‡æœŸï¼Œé‚£ä¹ˆå°±ä¼šè¿”å›ä¸€ä¸ªæ–°çš„access-tokenï¼Œå¦‚æœrefresh-tokenä¹Ÿè¿‡æœŸäº†å°±è¯´æ˜ç”¨æˆ·è¯ä¹¦å·²è¿‡æœŸéœ€è¦é‡æ–°é‰´æƒç™»å½•
:::
å†æ¬¡æˆ‘ä»¬æŠŠaccess-tokenè®¾ä¸º10msè¿‡æœŸï¼Œå¯åŠ¨åï¼ŒtokenUtilsä¼šè‡ªåŠ¨å°†å…¶åˆ·æ–°å¹¶æç¤ºå†…å®¹å·²ç»åˆ·æ–°
```java
@Test
    public void tesReFreshToken(){
        User user = new User("Genius",18);
        Claims claims = Jwts.claims();
        claims.put("user",user);
        Token<User> token = tokenUtils.createToken(
                Map.of("type","jwt","alg","HS256"), //tokenå¤´ä¿¡æ¯
                claims,                                             //token payload
                new Date(),                                         //tokenç­¾å‘æ—¶é—´
                new Date(new Date().getTime() + 10),           //tokenè¿‡æœŸæ—¶é—´
                new Date(new Date().getTime() + 120*1000),          //tokenåˆ·æ–°æ—¶é—´,å¦‚æœæœªå¯ç”¨åˆ™æ— æ•ˆ
                new Date(new Date().getTime()),           //Tokenç”Ÿæ•ˆæ—¶é—´
                "Genius",                                           //tokenç­¾åè€…
                "public Path",                                      //å…¬å…±åŒºåŸŸ
                tokenUtils.getJwtTokenProperties().getJit(),        //tokenå”¯ä¸€èº«ä»½æ ‡è¯†
                "Genius",                                           //å‘å¸ƒäºº
                true                                               //æ˜¯å¦éœ€è¦è¿›è¡Œåˆ·æ–°æ“ä½œ
        );
        System.out.println(token.getAccessToken());
        System.out.println(tokenUtils.refreshToken(token).getAccessToken());

    }
```
##### è¾“å‡º
```
2023-04-04 20:44:39.836  INFO 37416 --- [           main] c.genius.assistant.util.token.TokenUtil  : refresh token is disable,if you want to enable it,please set JWTTokenProperties.EnableRefreshToken to true
2023-04-04 20:44:55.934  INFO 37416 --- [           main] c.genius.assistant.util.token.TokenUtil  : access-token is expire,refreshing!
```

- `æ›´å¤šä¾‹å­å¯æŸ¥çœ‹teståŒ…ä¸‹é¢çš„samples`
- [TokenUtilsTest](https://github.com/969025903/Assistant/blob/master/src/test/java/com/genius/assistant/util/TokenUtilsTest.java)
